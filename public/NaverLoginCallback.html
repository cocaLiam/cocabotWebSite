<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <script
      type="text/javascript"
      src="https://static.nid.naver.com/js/naverLogin_implicit-1.0.3.js"
      charset="utf-8"
    ></script>
    <script
      type="text/javascript"
      src="http://code.jquery.com/jquery-1.11.3.min.js"
    ></script>
  </head>
  <body>
    <script type="module">
      import { jwtDecode } from "https://cdn.jsdelivr.net/npm/jwt-decode@4.0.0/+esm";

      // jwtDecode를 전역 변수로 만들어서 다른 스크립트에서도 사용할 수 있게 함
      window.jwtDecode = jwtDecode;
    </script>
    <script type="text/javascript">
      var naver_id_login = new naver_id_login(
        "<{VITE_NAVER_CLIENT_ID}>",
        "<{VITE_NAVER_CALLBACK_URL}>"
      );

      naver_id_login.get_naver_userprofile("naverSignInCallback()");
      // 네이버 사용자 프로필 조회 이후 프로필 정보를 처리할 callback function
      async function naverSignInCallback() {
        const email = naver_id_login.getProfileData("email"); // << 요거
        const nickname = naver_id_login.getProfileData("nickname");
        const profileImage = naver_id_login.getProfileData("profile_image");
        const age = naver_id_login.getProfileData("age");
        const gender = naver_id_login.getProfileData("gender");
        const id = naver_id_login.getProfileData("id");
        const name = naver_id_login.getProfileData("name"); // << 요거 만 있음
        const birthday = naver_id_login.getProfileData("birthday");

        // 객체 형태로 데이터 정리
        const userProfile = {
          email: email,
          nickname: nickname,
          profileImage: profileImage,
          age: age,
          gender: gender,
          id: id,
          name: name,
          birthday: birthday,
          idToken: naver_id_login.oauthParams.access_token,
        };

        // 백엔드 서버로 POST 요청
        try {
          const response = await fetch(
            "<{VITE_BACKEND_SERVER}>" + "/api/oauth/naverLogin",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ payload: userProfile }),
            }
          );

          const responseData = await response.json(); // 응답 데이터를 JSON으로 파싱

          // 로그인 성공 처리
          if (response.ok) {
            const { dbObjectId, token } = responseData;
            const newTokenExpiration = new Date(
              window.jwtDecode(token).exp * 1000
            );
            localStorage.setItem(
              "tokenData",
              JSON.stringify({
                dbObjectId,
                token,
                expiration: newTokenExpiration,
              })
            );

            window.location.href = "/"; // 로그인 성공 후 메인화면으로 링크 이동
          } else {
            console.error("서버 에러:", responseData.message || "로그인 실패");
            // window.location.href = `/login/Login?error=NaverLoginFail&errorMsg=${responseData.message}`

            /* CloudFront 오류페이지로 인해 배포서버에서는 허용된 접근이외에 Ban 처리됨 */
            // document.getElementById("loginStatus").textContent =
            //   "네이버 로그인 실패";
            // document.getElementById(
            //   "loginMessage"
            // ).innerHTML = `${responseData.message}`;

            // // 3초 후 루트 페이지로 이동
            // setTimeout(() => {
            //   window.location.href = `/login/Login?error=NaverLoginFail&errorMsg=${responseData.message}`;
            // }, 3000); // 3000ms = 3초

            // window.location.href = `/login/Login?error=NaverLoginFail&userProfile=${encodeURIComponent(JSON.stringify(userProfile))}`;
          }
        } catch (error) {
          console.error("요청 중 에러 발생:", error);
        }
      }
    </script>
    <h1 id="loginStatus">Naver Login ...</h1>
    <p id="loginMessage">wait a moment please</p>
  </body>
</html>
